---
title: 创建 Android 服务
description: 本指南讨论了 Xamarin Android 服务，它们是可让工作在没有活动用户界面的情况下执行的 Android 组件。 服务通常用于在后台执行的任务，如使用计算、下载文件、播放音乐等。 它介绍了服务适用的不同方案，并说明了如何实现它们来执行长时间运行的后台任务，以及如何为远程过程调用提供接口。
ms.prod: xamarin
ms.assetid: BA371A59-6F7A-F62A-02FC-28253504ACC9
ms.technology: xamarin-android
author: davidortinau
ms.author: daortin
ms.date: 03/19/2018
ms.openlocfilehash: b427bbadc72ca557a37c652e853674fdf849c2c8
ms.sourcegitcommit: 2fbe4932a319af4ebc829f65eb1fb1816ba305d3
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/29/2019
ms.locfileid: "73024559"
---
# <a name="creating-android-services"></a>创建 Android 服务

_本指南讨论了 Xamarin Android 服务，它们是可让工作在没有活动用户界面的情况下执行的 Android 组件。服务通常用于在后台执行的任务，如使用计算、下载文件、播放音乐等。它介绍了服务适用的不同方案，并说明了如何实现它们来执行长时间运行的后台任务，以及如何为远程过程调用提供接口。_

## <a name="android-services-overview"></a>Android 服务概述

移动应用程序与桌面应用程序不同。 桌面具有详细的资源，如屏幕房地产、内存、存储空间和连接的电源，移动设备不会这样做。 这些约束强制移动应用的行为方式不同。 例如，移动设备上的小屏幕通常表示一次只显示一个应用（即活动）。 其他活动会移动到后台并推送到处于挂起状态的状态，在此状态下，它们无法执行任何工作。 但是，这种情况下，由于 Android 应用程序处于后台，并不意味着应用程序无法继续工作。 

Android 应用程序由以下四个主要组件构成：_活动_、_广播接收器_、_内容提供商_和_服务_。 活动是许多优秀 Android 应用程序的基础，因为它们提供允许用户与应用程序进行交互的 UI。 但是，在执行并发或后台工作时，活动并不总是最佳选择。

Android 中后台工作的主要机制是_服务_。 Android 服务是一个组件，用于在没有用户界面的情况下执行某些工作。 服务可以下载文件、播放音乐，或将筛选器应用于映像。 服务还可用于 Android 应用程序之间的进程间通信（_IPC_）。 例如，一个 Android 应用可能使用来自其他应用的音乐播放机服务，或者一个应用可能会通过服务将数据（例如人员的联系信息）公开给其他应用。 

服务及其执行后台工作的能力对于提供平滑的流畅用户界面至关重要。 所有 Android 应用程序都具有运行活动的_主线程_（也称为_UI 线程_）。 为了保持设备响应能力，Android 必须能够以60帧/秒的速率更新用户界面。 如果 Android 应用在主线程上执行过多工作，则 Android 会丢弃帧，这进而导致 UI 显示抖动（有时也称为_janky_）。 这意味着在 UI 线程上执行的任何工作都应在两帧之间的时间范围内完成，大约为16毫秒（每60帧1秒）。 

为了解决这一问题，开发人员可以使用活动中的线程来执行一些会阻止 UI 的工作。 但是，这可能会导致问题。 很有可能 Android 会销毁并重新创建活动的多个实例。 但是，Android 不会自动销毁线程，这可能会导致内存泄漏。 这种情况的一个典型示例是在[设备旋转](~/android/app-fundamentals/handling-rotation.md)时 &ndash; Android 会尝试销毁活动实例，然后重新创建一个新实例：

![设备旋转时，实例1被销毁并创建实例2](images/image-01.png)

这是可能的内存泄漏 &ndash; 由活动的第一个实例创建的线程仍将运行。 如果线程具有对活动的第一个实例的引用，则这将阻止 Android 对对象进行垃圾回收。 但是，仍会创建活动的第二个实例（进而创建新的线程）。 迅速地多次旋转设备可能会耗尽所有 RAM，并强制 Android 终止整个应用程序以回收内存。

一般来说，如果要执行的工作应长于活动，则应创建一个服务来执行该操作。 但是，如果工作仅适用于活动的上下文，则创建用于执行工作的线程可能更合适。 例如，为刚添加到照片库应用中的照片创建缩略图可能出现在服务中。 但是，在活动处于前台时，线程可能更适合播放一些音乐。

可以将后台工作分为两大类别：

1. **长时间运行的任务**&ndash; 这是正在进行的工作，直到显式停止。 _长时间运行的任务_的一个示例是流式传输音乐或必须监视从传感器收集的数据的应用程序。 即使应用程序没有可见的用户界面，这些任务也必须运行。
2. **定期任务**&ndash; （有时称为_作业_）定期执行的任务是相对较短的持续时间（几秒钟），按计划运行（即一周一天一次，或在接下来的60秒内只需一次）。 例如，从 internet 下载文件或生成图像缩略图。

有四种不同类型的 Android 服务：

* **绑定服务 &ndash;** 绑定_服务_是一种服务，该服务具有与之绑定的其他某个组件（通常为活动）。 绑定服务提供了一个接口，该接口允许绑定组件和服务彼此交互。 如果没有更多的客户端绑定到服务，则 Android 会关闭服务。 

* **`IntentService`** &ndash; _`IntentService`_ 是 `Service` 类的专用子类，可简化服务的创建和使用。 `IntentService` 旨在处理单独的自治调用。 与可同时处理多个调用的服务不同，`IntentService` 更像是_工作队列处理器_&ndash; 工作已排队，`IntentService` 在单个工作线程上一次处理一个作业。 通常，`IntentService` 未绑定到活动或片段。 

* **已启动的服务 &ndash; 已**_启动的服务是由_其他某个 Android 组件（如活动）启动的服务，并在后台持续运行，直到某些内容明确通知服务停止。 与绑定服务不同，已启动的服务没有任何直接绑定到它的客户端。 出于此原因，设计启动的服务非常重要，这样就可以在必要时正确地重新启动服务。

* **混合服务 &ndash;** _混合服务_是一种服务，它具有已_启动服务_和_绑定服务_的特性。 当某个组件绑定到混合服务时，它可以启动，也可以由某个事件启动。 客户端组件可以或不绑定到混合服务。 混合服务将一直运行，直到显式告知它停止，或直到没有更多的客户端绑定到它。

使用哪种类型的服务非常依赖于应用程序要求。 作为经验法则，`IntentService` 或绑定服务足以满足 Android 应用程序必须执行的大多数任务，因此应将首选项提供给这两种类型的服务之一。 对于 "一次" 任务（例如下载文件），`IntentService` 是一个不错的选择，而当需要频繁与活动/片段交互时，就适合使用绑定服务。 

大多数服务在后台运行时，有一种特殊的子类别称为 "_前台服务_"。 这是一种服务，为用户执行一些工作（如播放音乐）提供了较高的优先级（与普通服务相比）。 

还可以在同一设备上的自己的进程中运行服务，这有时称为 "_远程服务_" 或 "_进程外服务_"。 这确实需要更多的精力来创建，但在应用程序需要与其他应用程序共享功能时，可以使用此方法，并且在某些情况下，可以提高应用程序的用户体验。 

### <a name="background-execution-limits-in-android-80"></a>Android 8.0 中的后台执行限制

从 Android 8.0 （API 级别26）开始，Android 应用程序不再能够在后台自由地运行。 在前台，应用程序可以在不受限制的情况下启动并运行服务。 当应用程序移到后台时，Android 会在一定时间内为应用授予启动和使用服务的时间。 经过一段时间后，应用程序就不能再启动任何服务，任何已启动的服务都将被终止。 此时，应用无法执行任何操作。 如果满足以下条件之一，则 Android 会将应用程序视为处于前台：

* 存在可见的活动（已启动或已暂停）。
* 应用已启动前台服务。
* 另一个应用处于前台，并使用应用中的组件，此应用程序将在后台进行。 例如，如果应用程序 A （在前台）绑定到应用程序 B 提供的服务，则会出现这种情况。在前台，应用程序 B 还将被视为前台，而 Android 不会将其终止。

在某些情况下，即使应用处于后台，Android 也会唤醒应用并放宽这些限制几分钟，允许应用执行一些工作：

* 应用收到高优先级 Firebase 云消息。
* 应用收到广播。 
* 应用程序接收并执行 `PendingIntent` 以响应通知。

现有的 Xamarin 应用程序可能必须更改执行后台工作的方式，以避免 Android 8.0 上可能出现的任何问题。 下面是一些适用于 Android 服务的实用替代方案：

* **使用 Android 作业计划程序或[Firebase 作业调度](~/android/platform/firebase-job-dispatcher.md)程序在后台中计划要运行的工作**&ndash; 这两个库为应用程序提供一个框架，用于将后台工作隔离到_作业_中，这是一个离散工作单元。 然后，应用程序可以通过操作系统来计划作业，以及有关作业运行时间的一些条件。
* **在前台启动服务**&ndash; 前台服务适用于应用必须在后台执行某些任务的情况，并且用户可能需要定期与该任务交互。 前台服务将显示一个持续性通知，以使用户知道该应用正在运行后台任务，同时提供监视或与该任务交互的方法。 例如，将播客的应用程序播放到用户，或下载播客节目，以便以后可以使用它。 
* **使用高优先级 Firebase 云消息（FCM）** &ndash; 当 Android 收到适用于应用的高优先级 FCM 时，它将允许该应用在后台运行服务一段时间。 这是具有在后台轮询应用的后台服务的好办法。 
* 如果以前的解决方案都不可行，则在应用进入**前台 &ndash; 时延迟工作**，应用程序必须在应用程序进入前台时开发自己的方法来暂停和恢复工作。

## <a name="related-links"></a>相关链接

* [Android Oreo 后台执行限制](https://www.youtube.com/watch?v=Pumf_4yjTMc)
